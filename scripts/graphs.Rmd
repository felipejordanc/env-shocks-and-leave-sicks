# --- Libraries ---
library(haven)
library(dplyr)
library(ggplot2)

# --- Input and Output Paths ---
base_path <- "C:/Users/black/Dropbox/Sick Leave, Heat, Pollution/data/B_intermediate/"
out_path  <- "C:/Users/black/Documents/GitHub/env-shocks-and-leave-sicks/graphs/"

# --- Files to process ---
files <- list(
  tmax = paste0(base_path, "climate_tmax.dta"),
  tmin = paste0(base_path, "climate_tmin.dta"),
  pr   = paste0(base_path, "climate_pr.dta")
)

# --- Function to process and plot each dataset ---
process_climate <- function(file_path, var_name) {
  message(paste("Processing:", var_name))

  # --- STEP 1: Read and prepare data ---
  data <- read_dta(file_path)
  data$year <- format(data$date, "%Y")

  # Average by comuna-year
  df_s <- data %>%
    group_by(cod_comuna, year) %>%
    summarise(tempe = mean(value, na.rm = TRUE), .groups = "drop")

  # --- STEP 2: Normalize each comuna (baseline = 100) ---
  df <- df_s %>%
    group_by(cod_comuna) %>%
    arrange(year, .by_group = TRUE) %>%
    mutate(
      baseline = first(tempe),
      temp = 100 * tempe / baseline
    ) %>%
    ungroup()
  # --- STEP 4: Compute cumulative/consistent growth per comuna ---
  growth_summary <- df %>%
    group_by(cod_comuna) %>%
    summarise(
      cum_growth = mean(temp - 100, na.rm = TRUE),  # average % above baseline
      .groups = "drop"
    )
  # --- STEP 5.1: Trim outliers (5–95 percentile) ---
  p5  <- quantile(growth_summary$cum_growth, 0.05, na.rm = TRUE)
  p95 <- quantile(growth_summary$cum_growth, 0.95, na.rm = TRUE)
  growth_summary <- growth_summary %>%
    filter(cum_growth >= p5, cum_growth <= p95)
    
    # Filter the main df to keep only trimmed comunas
  df <- df %>%
    filter(cod_comuna %in% growth_summary$cod_comuna)
  # --- STEP 3: Compute yearly mean across comunas (cod_comuna = 20000) ---
  df_mean <- df %>%
    group_by(year) %>%
    summarise(
      temp = mean(temp, na.rm = TRUE),
      cod_comuna = 20000
    )



  # Identify key comunas
  most_growth_id   <- growth_summary$cod_comuna[which.max(growth_summary$cum_growth)]
  least_growth_id  <- growth_summary$cod_comuna[which.min(growth_summary$cum_growth)]
  mean_growth_val  <- mean(growth_summary$cum_growth, na.rm = TRUE)
  closest_mean_id  <- growth_summary$cod_comuna[which.min(abs(growth_summary$cum_growth - mean_growth_val))]

  # --- STEP 5: Create labeled versions for plotting ---
  df_most  <- df %>% filter(cod_comuna == most_growth_id)  %>% mutate(cod_comuna = 30001)
  df_least <- df %>% filter(cod_comuna == least_growth_id) %>% mutate(cod_comuna = 30002)
  df_mid   <- df %>% filter(cod_comuna == closest_mean_id) %>% mutate(cod_comuna = 30003)

  # Combine all data
  df_final <- bind_rows(df, df_mean, df_most, df_least, df_mid)

  # --- STEP 6: Plot ---
  p <- ggplot(df_final, aes(x = as.numeric(year), y = temp, group = cod_comuna)) +
    # Background lines
    geom_line(aes(color = "Other comunas"), alpha = 0.2, linewidth = 0.3, show.legend = FALSE) +

    # Highlight Mean
    geom_line(
      data = subset(df_final, cod_comuna == 20000),
      aes(color = "Mean"),
      linewidth = 1
    ) +
    # Highlight Most Growth
    geom_line(
      data = subset(df_final, cod_comuna == 30001),
      aes(color = "Highest growth"),
      linewidth = 1
    ) +
    # Highlight Least Growth
    geom_line(
      data = subset(df_final, cod_comuna == 30002),
      aes(color = "Lowest growth"),
      linewidth = 1
    ) +
    # Highlight Closest to Mean
    geom_line(
      data = subset(df_final, cod_comuna == 30003),
      aes(color = "Closest to mean"),
      linewidth = 1
    ) +

    # Manual color and legend labels
    scale_color_manual(values = c(
      "Other comunas" = "gray60",
      "Mean" = "black",
      "Highest growth" = "red",
      "Lowest growth" = "green",
      "Closest to mean" = "blue"
    )) +

    # Titles and labels
    labs(
      x = "Year",
      y = "Climate Index (baseline = 100)",
      color = "Comuna type",
      title = paste("Climate Trends by Comuna -", toupper(var_name)),
      subtitle = paste0(
        "Highlighted automatically:\n",
        "Highest growth: ", most_growth_id, " | ",
        "Lowest growth: ", least_growth_id, " | ",
        "Closest to mean: ", closest_mean_id
      )
    ) +
    theme_minimal()

  # --- STEP 7: Export data and plot ---
  ggsave(
    filename = paste0(out_path, "plot_", var_name, ".png"),
    plot = p,
    width = 8,
    height = 5,
    dpi = 300
  )

  message(paste("✅ Done:", var_name))
  return(list(data = df_final, plot = p))
}

# --- STEP 8: Run loop for all variables ---
results <- lapply(names(files), function(nm) process_climate(files[[nm]], nm))
names(results) <- names(files)



# --- Input and Output Paths ---
base_path <- "C:/Users/black/Dropbox/Sick Leave, Heat, Pollution/data/B_intermediate/"
out_path  <- "C:/Users/black/Documents/GitHub/env-shocks-and-leave-sicks/graphs/"

# --- STEP 1: Load one dataset containing all variables ---
data <- read_dta(paste0(base_path, "pollution.dta"))

# Expect structure like: cod_comuna, date, tmax, tmin, pr
data$year <- format(data$date, "%Y")

# --- Variables to process ---
vars <- c("meanMP10", "meanMP25", "meanNOX", "meanO3")

# --- Function to process and plot each variable ---
process_var <- function(df, var_name) {
  message(paste("Processing:", var_name))
  
  # --- STEP 2: Average by comuna-year for that variable ---
  df_s <- df %>%
    group_by(cod_comuna, year) %>%
    summarise(
      tempe = mean(.data[[var_name]], na.rm = TRUE),
      .groups = "drop"
    )

  # --- STEP 3: Normalize (baseline = 100) ---
  df_norm <- df_s %>%
    group_by(cod_comuna) %>%
    arrange(year, .by_group = TRUE) %>%
    mutate(
      baseline = first(tempe),
      temp = 100 * tempe / baseline
    ) %>%
    ungroup()
  # --- STEP 5: Consistent (cumulative) growth ---
  growth_summary <- df_norm %>%
    group_by(cod_comuna) %>%
    summarise(
      cum_growth = mean(temp - 100, na.rm = TRUE),
      .groups = "drop"
    )
    # --- STEP 5.1: Trim outliers (5–95 percentile) ---
  p5  <- quantile(growth_summary$cum_growth, 0.05, na.rm = TRUE)
  p95 <- quantile(growth_summary$cum_growth, 0.95, na.rm = TRUE)
  growth_summary <- growth_summary %>%
    filter(cum_growth >= p5, cum_growth <= p95)
  # Filter the main df to keep only trimmed comunas
  df_norm <- df_norm %>%
    filter(cod_comuna %in% growth_summary$cod_comuna)
  # --- STEP 4: Compute yearly mean (cod_comuna = 20000) ---
  df_mean <- df_norm %>%
    group_by(year) %>%
    summarise(
      temp = mean(temp, na.rm = TRUE),
      cod_comuna = 20000
    )



  most_growth_id   <- growth_summary$cod_comuna[which.max(growth_summary$cum_growth)]
  least_growth_id  <- growth_summary$cod_comuna[which.min(growth_summary$cum_growth)]
  mean_growth_val  <- mean(growth_summary$cum_growth, na.rm = TRUE)
  closest_mean_id  <- growth_summary$cod_comuna[which.min(abs(growth_summary$cum_growth - mean_growth_val))]

  # --- STEP 6: Create labeled versions ---
  df_most  <- df_norm %>% filter(cod_comuna == most_growth_id)  %>% mutate(cod_comuna = 30001)
  df_least <- df_norm %>% filter(cod_comuna == least_growth_id) %>% mutate(cod_comuna = 30002)
  df_mid   <- df_norm %>% filter(cod_comuna == closest_mean_id) %>% mutate(cod_comuna = 30003)
  
  df_final <- bind_rows(df_norm, df_mean, df_most, df_least, df_mid)

  # --- STEP 7: Plot ---
  p <- ggplot(df_final, aes(x = as.numeric(year), y = temp, group = cod_comuna)) +
    geom_line(aes(color = "Other comunas"), alpha = 0.2, linewidth = 0.3, show.legend = FALSE) +
    geom_line(data = subset(df_final, cod_comuna == 20000), aes(color = "Mean"), linewidth = 1) +
    geom_line(data = subset(df_final, cod_comuna == 30001), aes(color = "Highest growth"), linewidth = 1) +
    geom_line(data = subset(df_final, cod_comuna == 30002), aes(color = "Lowest growth"), linewidth = 1) +
    geom_line(data = subset(df_final, cod_comuna == 30003), aes(color = "Closest to mean"), linewidth = 1) +
    scale_color_manual(values = c(
      "Other comunas" = "gray60",
      "Mean" = "black",
      "Highest growth" = "red",
      "Lowest growth" = "green",
      "Closest to mean" = "blue"
    )) +
    labs(
      x = "Year",
      y = paste0(toupper(var_name), " Index (baseline = 100)"),
      color = "Comuna type",
      title = paste("Pollution Trends by Comuna -", toupper(var_name)),
      subtitle = paste0(
        "Highlighted automatically:\n",
        "Highest growth: ", most_growth_id, " | ",
        "Lowest growth: ", least_growth_id, " | ",
        "Closest to mean: ", closest_mean_id
      )
    ) +
    theme_minimal()

  # --- STEP 8: Export ---
  ggsave(
    filename = paste0(out_path, "plot_", var_name, ".png"),
    plot = p,
    width = 8, height = 5, dpi = 300
  )

  message(paste("✅ Done:", var_name))
  return(list(data = df_final, plot = p))
}

# --- STEP 9: Loop over variables ---
results <- lapply(vars, function(v) process_var(data, v))
names(results) <- vars

########################################################
########################################################
# LOAD PACKAGES
########################################################

library(tidyverse)

########################################################
# READ .TEX FILE
########################################################

tex_file <- "C:/Users/black/Documents/GitHub/env-shocks-and-leave-sicks/tables/y_sick_w.tex"
raw <- readLines(tex_file)

########################################################
# IDENTIFY COEFFICIENT AND SE ROWS
########################################################

coef_rows <- raw[str_detect(raw, "^tmax\\\\_dum")]
se_rows   <- raw[str_detect(raw, "^\\s*&\\s*\\(")]

########################################################
# HELPERS
########################################################

clean_row <- function(x) {
  x |>
    str_replace_all("\\\\sym\\{\\*+\\}", "")
}

clean_num <- function(x) {
  x |>
    str_squish() |>
    as.numeric()
}

extract_cells <- function(x) {
  str_split(x, "&")[[1]][-1] |>
    str_remove_all("\\\\") |>
    str_trim()
}

########################################################
# PARSE COEFFICIENTS
########################################################

coef_df <- tibble(row = coef_rows) |>
  mutate(
    row = clean_row(row),
    bin = str_extract(row, "dum\\\\_[0-9_]+") |>
      str_replace_all("\\\\_", "_"),
    vals = map(row, extract_cells)
  ) |>
  unnest_wider(vals, names_sep = "_") |>
  mutate(across(starts_with("vals"), clean_num))

########################################################
# PARSE STANDARD ERRORS
########################################################

se_df <- tibble(row = se_rows) |>
  mutate(
    vals = map(
      row,
      ~ str_extract_all(.x, "\\(([0-9\\.]+)\\)")[[1]] |>
        str_remove_all("[()]") |>
        as.numeric()
    )
  ) |>
  unnest_wider(vals, names_sep = "_")

########################################################
# COMBINE + LONG FORMAT
########################################################

models <- c("Dummy", "Spain", "Reactive", "Anticipated")

coef_long <- coef_df |>
  pivot_longer(
    cols = starts_with("vals"),
    names_to = "model_id",
    values_to = "estimate"
  ) |>
  mutate(
    model = models[as.integer(str_remove(model_id, "vals_"))]
  ) |>
  select(bin, model, estimate)

se_long <- coef_df |>
  select(bin) |>
  bind_cols(se_df) |>
  pivot_longer(
    cols = starts_with("vals"),
    names_to = "model_id",
    values_to = "se"
  ) |>
  mutate(
    model = models[as.integer(str_remove(model_id, "vals_"))]
  ) |>
  select(bin, model, se)

reg_long <- coef_long |>
  left_join(se_long, by = c("bin", "model")) |>
  mutate(
    lower = estimate - 1.96 * se,
    upper = estimate + 1.96 * se
  )

########################################################
# BIN LABELS + ORDER (AUTHORITATIVE)
########################################################

NEW_LABELS <- c(
  dum_9  = "< 9",
  dum_10 = "10–11",
  dum_12 = "12–13",
  dum_14 = "14–15",
  dum_16 = "16–17",
  dum_18 = "18–19",
  dum_20 = "20–21",
  dum_22 = "22–23",
  dum_24 = "24–25",
  dum_26 = "26–27",
  dum_28 = "28–29",
  dum_30 = "30–31",
  dum_32 = "32–33",
  dum_34 = "34–35",
  dum_36 = "36–37",
  dum_38 = "> 38"
)

bin_order <- names(NEW_LABELS)

########################################################
# COMPLETE DATA + FIX COLOR INDEX (KEY FIX)
########################################################

reg_long <- reg_long |>
  complete(
    model,
    bin = bin_order,
    fill = list(
      estimate = NA_real_,
      se       = NA_real_,
      lower    = NA_real_,
      upper    = NA_real_
    )
  ) |>
  mutate(
    bin_index = match(bin, bin_order),
    bin_label = factor(
      recode(bin, !!!NEW_LABELS),
      levels = NEW_LABELS
    )
  )

########################################################
# COLOR PALETTE (ORIGINAL)
########################################################

my_cols <- function(n) {
  grDevices::colorRampPalette(
    c("#4575b4", "#ffffbf", "#d73027")
  )(n)
}

n_bins <- length(bin_order)

########################################################
# SINGLE FIGURE (COLOR IS NOW CORRECT)
########################################################

p <- ggplot(
  reg_long,
  aes(
    x = bin_label,
    y = estimate,
    fill = bin_index
  )
) +
  geom_col(width = 0.8, na.rm = TRUE) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    width = 0.15,
    color = "black",
    na.rm = TRUE
  ) +
  facet_wrap(~ model, ncol = 2) +
  scale_fill_gradientn(
    colors = my_cols(n_bins),
    limits = c(1, n_bins),     # <-- CRITICAL
    guide = "none"
  ) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_cartesian(ylim = c(-0.1, 0.5)) +
  labs(
    x = "Bin",
    y = "Estimate",
    title = "Regression Coefficients by Model"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

########################################################
# SAVE OUTPUT
########################################################

ggsave(
  "all_models.png",
  p,
  width = 14,
  height = 10,
  dpi = 300
)

########################################################
# LOAD PACKAGES
########################################################

library(tidyverse)

########################################################
# READ .TEX FILE
########################################################

tex_file <- "C:/Users/black/Documents/GitHub/env-shocks-and-leave-sicks/tables/y_sick_w_min.tex"
raw <- readLines(tex_file)

########################################################
# IDENTIFY COEFFICIENT AND SE ROWS
########################################################

coef_rows <- raw[str_detect(raw, "^tmin\\\\_dum")]
se_rows   <- raw[str_detect(raw, "^\\s*&\\s*\\(")]

########################################################
# HELPERS
########################################################

clean_row <- function(x) {
  x |>
    str_replace_all("\\\\sym\\{\\*+\\}", "")
}

clean_num <- function(x) {
  x |>
    str_squish() |>
    as.numeric()
}

extract_cells <- function(x) {
  str_split(x, "&")[[1]][-1] |>
    str_remove_all("\\\\") |>
    str_trim()
}

########################################################
# PARSE COEFFICIENTS
########################################################

coef_df <- tibble(row = coef_rows) |>
  mutate(
    row = clean_row(row),
    bin = str_extract(row, "dum\\\\_[0-9_]+") |>
      str_replace_all("\\\\_", "_"),
    vals = map(row, extract_cells)
  ) |>
  unnest_wider(vals, names_sep = "_") |>
  mutate(across(starts_with("vals"), clean_num))

########################################################
# PARSE STANDARD ERRORS
########################################################

se_df <- tibble(row = se_rows) |>
  mutate(
    vals = map(
      row,
      ~ str_extract_all(.x, "\\(([0-9\\.]+)\\)")[[1]] |>
        str_remove_all("[()]") |>
        as.numeric()
    )
  ) |>
  unnest_wider(vals, names_sep = "_")

########################################################
# COMBINE + LONG FORMAT
########################################################

models <- c("Dummy", "Spain", "Reactive", "Anticipated")

coef_long <- coef_df |>
  pivot_longer(
    cols = starts_with("vals"),
    names_to = "model_id",
    values_to = "estimate"
  ) |>
  mutate(
    model = models[as.integer(str_remove(model_id, "vals_"))]
  ) |>
  select(bin, model, estimate)

se_long <- coef_df |>
  select(bin) |>
  bind_cols(se_df) |>
  pivot_longer(
    cols = starts_with("vals"),
    names_to = "model_id",
    values_to = "se"
  ) |>
  mutate(
    model = models[as.integer(str_remove(model_id, "vals_"))]
  ) |>
  select(bin, model, se)

reg_long <- coef_long |>
  left_join(se_long, by = c("bin", "model")) |>
  mutate(
    lower = estimate - 1.96 * se,
    upper = estimate + 1.96 * se
  )

########################################################
# BIN LABELS + ORDER (WITH EMPTY dum_8)
########################################################

NEW_LABELS <- c(
  dum_1  = "< 0",
  dum_0  = "0–1",
  dum_2  = "2–3",
  dum_4  = "4–5",
  dum_6  = "6–7",
  dum_8  = "8–9",     # EMPTY BIN
  dum_10 = "10–11",
  dum_12 = "12–13",
  dum_14 = "14–15",
  dum_16 = "16–17",
  dum_18 = "18–19",
  dum_20 = ">20"
)

bin_order <- names(NEW_LABELS)
n_bins <- length(bin_order)

########################################################
# COMPLETE DATA + STRUCTURAL COLOR INDEX
########################################################

reg_long <- reg_long |>
  complete(
    model,
    bin = bin_order,
    fill = list(
      estimate = NA_real_,
      se       = NA_real_,
      lower    = NA_real_,
      upper    = NA_real_
    )
  ) |>
  mutate(
    bin_index = match(bin, bin_order),
    bin_label = factor(
      recode(bin, !!!NEW_LABELS),
      levels = NEW_LABELS
    )
  )

########################################################
# COLOR PALETTE (ORIGINAL)
########################################################

my_cols <- function(n) {
  grDevices::colorRampPalette(
    c("#4575b4", "#ffffbf", "#d73027")
  )(n)
}

########################################################
# SINGLE FIGURE WITH FACETS (CORRECT COLORS)
########################################################

p <- ggplot(
  reg_long,
  aes(
    x = bin_label,
    y = estimate,
    fill = bin_index
  )
) +
  geom_col(width = 0.8, na.rm = TRUE) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    width = 0.15,
    color = "black",
    na.rm = TRUE
  ) +
  facet_wrap(~ model, ncol = 2) +
  scale_fill_gradientn(
    colors = my_cols(n_bins),
    limits = c(1, n_bins),
    guide = "none"
  ) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_cartesian(ylim = c(-0.1, 0.5)) +
  labs(
    x = "Bin",
    y = "Estimate",
    title = "Regression Coefficients by Model"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

########################################################
# SAVE OUTPUT
########################################################

ggsave(
  "all_models_tmin.png",
  p,
  width = 14,
  height = 10,
  dpi = 300
)


########################################################

# Load required packages
library(tidyverse)

#----------------------------------------------------------
# 1. READ & PARSE .TEX REGRESSION TABLE AUTOMATICALLY
#----------------------------------------------------------

tex_file <- "C:/Users/black/Documents/GitHub/env-shocks-and-leave-sicks/tables/y_sick0_pol_tot_dum.tex"   # ← change to your .tex path

raw <- readLines(tex_file)
#----------------------------------------------------------
# 2. EXTRACT COEFFICIENT ROWS (dum\_ pattern)
#----------------------------------------------------------

coef_rows <- raw[str_detect(raw, "dum\\\\_")]

se_rows   <- raw[str_detect(raw, "^\\s*&\\s*\\(")]

########################################################
# 3. HELPERS
########################################################

# IMPORTANT: remove \sym{...} FIRST
clean_row <- function(x) {
  x |>
    str_replace_all("\\\\sym\\{\\*+\\}", "")
}

clean_num <- function(x) {
  x |>
    str_squish() |>
    as.numeric()
}

extract_cells <- function(x) {
  str_split(x, "&")[[1]][-1] |>
    str_remove_all("\\\\") |>
    str_trim()
}

########################################################
# 4. PARSE COEFFICIENTS (ALL 4, FIXED)
########################################################

coef_df <- tibble(row = coef_rows) |>
  mutate(
    row = clean_row(row),   # <-- FIX HERE
    bin = str_extract(row, "dum\\\\_[0-9_]+") |>
      str_replace_all("\\\\_", "_"),
    vals = map(row, extract_cells)
  ) |>
  unnest_wider(vals, names_sep = "_") |>
  mutate(across(starts_with("vals"), clean_num))

########################################################
# 5. PARSE STANDARD ERRORS (ALL 4)
########################################################

se_df <- tibble(row = se_rows) |>
  mutate(
    vals = map(
      row,
      ~ str_extract_all(.x, "\\(([0-9\\.]+)\\)")[[1]] |>
        str_remove_all("[()]") |>
        as.numeric()
    )
  ) |>
  unnest_wider(vals, names_sep = "_")

########################################################
# 6. COMBINE + LONG FORMAT
########################################################

models <- c("maxMP10", "maxMP10_mean", "maxMP25", "maxMP25_mean", "meanMP10", "meanMP10_max", "meanMP25", "meanMP25_max",)

# ---- coefficients to long ----
coef_long <- coef_df |>
  pivot_longer(
    cols = starts_with("vals"),
    names_to = "model_id",
    values_to = "estimate"
  ) |>
  mutate(
    model = models[as.integer(str_remove(model_id, "vals_"))]
  ) |>
  select(bin, model, estimate)

# ---- SEs to long ----
se_long <- coef_df |>
  select(bin) |>
  bind_cols(se_df) |>
  pivot_longer(
    cols = starts_with("vals"),
    names_to = "model_id",
    values_to = "se"
  ) |>
  mutate(
    model = models[as.integer(str_remove(model_id, "vals_"))]
  ) |>
  select(bin, model, se)


# ---- combine correctly (JOIN, not bind_cols) ----
reg_long <- coef_long |>
  left_join(se_long, by = c("bin", "model")) |>
  group_by(model) |>
  mutate(
    lower = estimate - 1.96 * se,
    upper = estimate + 1.96 * se,
    bin_index = row_number()
  ) |>
  ungroup()



########################################################
# 7. BIN LABELS (UNCHANGED)
########################################################

NEW_LABELS <- c(
  dum_9 = "< 9",
  dum_10 = "10–11",
  dum_12 = "12–13",
  dum_14 = "14–15",
  dum_16 = "16–17",
  dum_18 = "18–19",
  dum_22 = "22–23",
  dum_24 = "24–25",
  dum_26 = "26–27",
  dum_28 = "28–29",
  dum_30 = "30–31",
  dum_32 = "32–33",
  dum_34 = "34–35",
  dum_36 = "36–37",
  dum_38 = "> 38"
)

reg_long <- reg_long |>
  mutate(bin_label = recode(bin, !!!NEW_LABELS))

########################################################
# 8. PLOTTING FUNCTION
########################################################

plot_model <- function(df, subtitle_text) {
  ggplot(df, aes(
    x = fct_inorder(bin_label),
    y = estimate,
    fill = bin_index
  )) +
    geom_col(width = 0.8) +
    geom_errorbar(
      aes(ymin = lower, ymax = upper),
      width = 0.15,
      color = "black"
    ) +
    scale_fill_gradientn(
      colors = my_cols(seq(0, 1, length.out = nrow(df))),
      guide = "none"
    ) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    coord_cartesian(ylim = c(-0.1, 0.5)) +
    labs(
      x = "Bin",
      y = "Estimate",
      title = "Regression Coefficients ",
      subtitle = subtitle_text
    ) +
    theme_minimal(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 60, hjust = 1),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank()
    )
}

########################################################
# 9. GENERATE & SAVE PLOTS
########################################################
# Gradient palette (same behavior as before)
my_cols <- function(x) {
  grDevices::colorRampPalette(c("#4575b4", "#ffffbf", "#d73027"))(length(x))
}
plots <- split(reg_long, reg_long$model) |>
  map(~ plot_model(.x, unique(.x$model)))

ggsave("dummy.png",       plots$Dummy,       width = 12, height = 8, dpi = 300)
ggsave("spain.png",       plots$Spain,       width = 12, height = 8, dpi = 300)
ggsave("reactive.png",    plots$Reactive,    width = 12, height = 8, dpi = 300)
ggsave("anticipated.png", plots$Anticipated, width = 12, height = 8, dpi = 300)



########################################################
# LIBRARIES
########################################################

library(tidyverse)

########################################################
# READ .TEX FILE
########################################################

tex_file <- "C:/Users/black/Documents/GitHub/env-shocks-and-leave-sicks/tables/income_tmax_graph.tex"

raw <- readLines(tex_file)

########################################################
# IDENTIFY COEFFICIENT AND SE ROWS
########################################################

coef_rows <- raw[str_detect(raw, "^tmax\\\\_dum")]
se_rows   <- raw[str_detect(raw, "^\\s*&\\s*\\(")]

########################################################
# HELPERS
########################################################

clean_row <- function(x) {
  x |>
    str_replace_all("\\\\sym\\{\\*+\\}", "")
}

clean_num <- function(x) {
  x |>
    str_squish() |>
    as.numeric()
}

extract_cells <- function(x) {
  str_split(x, "&")[[1]][-1] |>
    str_remove_all("\\\\") |>
    str_trim()
}

########################################################
# PARSE COEFFICIENTS
########################################################

coef_df <- tibble(row = coef_rows) |>
  mutate(
    row = clean_row(row),
    bin = str_extract(row, "dum\\\\_[0-9_]+") |>
      str_replace_all("\\\\_", "_"),
    vals = map(row, extract_cells)
  ) |>
  unnest_wider(vals, names_sep = "_") |>
  mutate(across(starts_with("vals"), clean_num))

########################################################
# PARSE STANDARD ERRORS
########################################################

se_df <- tibble(row = se_rows) |>
  mutate(
    vals = map(
      row,
      ~ str_extract_all(.x, "\\(([0-9\\.]+)\\)")[[1]] |>
        str_remove_all("[()]") |>
        as.numeric()
    )
  ) |>
  unnest_wider(vals, names_sep = "_")

########################################################
# MODEL TITLES (AUTHORITATIVE ORDER)
########################################################

model_titles <- c(
  "Low Income_Cold",
  "Low Income_Temperate",
  "Low Income_Hot",
  "Middle Income_Cold",
  "Middle Income_Temperate",
  "Middle Income_Hot",
  "High Income_Cold",
  "High Income_Temperate",
  "High Income_Hot"
) |>
  str_replace("_", " - ")

########################################################
# LONG FORMAT (9 MODELS, ORDER PRESERVED)
########################################################

coef_long <- coef_df |>
  pivot_longer(
    cols = starts_with("vals"),
    names_to = "model_id",
    values_to = "estimate"
  ) |>
  mutate(
    model_index = as.integer(str_remove(model_id, "vals_")),
    model = model_titles[model_index]
  ) |>
  select(bin, model, model_index, estimate)

se_long <- coef_df |>
  select(bin) |>
  bind_cols(se_df) |>
  pivot_longer(
    cols = starts_with("vals"),
    names_to = "model_id",
    values_to = "se"
  ) |>
  mutate(
    model_index = as.integer(str_remove(model_id, "vals_")),
    model = model_titles[model_index]
  ) |>
  select(bin, model, model_index, se)

reg_long <- coef_long |>
  left_join(se_long, by = c("bin", "model", "model_index")) |>
  mutate(
    lower = estimate - 1.96 * se,
    upper = estimate + 1.96 * se
  )

########################################################
# BIN LABELS + ORDER (AUTHORITATIVE)
########################################################

NEW_LABELS <- c(
  dum_9  = "< 9",
  dum_10 = "10–11",
  dum_12 = "12–13",
  dum_14 = "14–15",
  dum_16 = "16–17",
  dum_18 = "18–19",
  dum_20 = "20–21",
  dum_22 = "22–23",
  dum_24 = "24–25",
  dum_26 = "26–27",
  dum_28 = "28–29",
  dum_30 = "30–31",
  dum_32 = "32–33",
  dum_34 = "34–35",
  dum_36 = "36–37",
  dum_38 = "> 38"
)

bin_order <- names(NEW_LABELS)

########################################################
# COMPLETE DATA + LOCK FACET ORDER (OPTIONAL FIX)
########################################################

reg_long <- reg_long |>
  complete(
    model,
    bin = bin_order,
    fill = list(
      estimate = 0,
      se       = 0,
      lower    = 0,
      upper    = 0
    )
  ) |>
  mutate(
    bin_index = match(bin, bin_order),
    bin_label = factor(
      recode(bin, !!!NEW_LABELS),
      levels = NEW_LABELS
    ),
    model = factor(model, levels = model_titles)
  )

########################################################
# LINE PLOT WITH CI RIBBON
########################################################

p <- ggplot(
  reg_long,
  aes(
    x = bin_index,
    y = estimate
  )
) +
  geom_ribbon(
    aes(ymin = lower, ymax = upper),
    fill = "grey70",
    alpha = 0.4
  ) +
  geom_line(
    color = "red",
    linewidth = 1
  ) +
  geom_point(
    color = "red",
    size = 2
  ) +
  geom_hline(
    yintercept = 0,
    color = "black",
    linewidth = 0.6
  ) +
  facet_wrap(~ model, ncol = 3) +
  scale_x_continuous(
    breaks = seq_along(bin_order),
    labels = NEW_LABELS
  ) +
  coord_cartesian(ylim = c(-1, 1)) +
  labs(
    x = "Bin",
    y = "Estimate",
    title = "Regression Coefficients - Max Temperature"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

########################################################
# SAVE OUTPUT
########################################################

ggsave(
  "all_models_line_ci.png",
  p,
  width = 16,
  height = 10,
  dpi = 300
)

########################################################
# LIBRARIES
########################################################

library(tidyverse)

########################################################
# READ .TEX FILE
########################################################

tex_file <- "C:/Users/black/Documents/GitHub/env-shocks-and-leave-sicks/tables/income_tmax_graph2.tex"

raw <- readLines(tex_file)

########################################################
# IDENTIFY COEFFICIENT AND SE ROWS
########################################################

coef_rows <- raw[str_detect(raw, "^tmax\\\\_dum")]
se_rows   <- raw[str_detect(raw, "^\\s*&\\s*\\(")]

########################################################
# HELPERS
########################################################

clean_row <- function(x) {
  x |>
    str_replace_all("\\\\sym\\{\\*+\\}", "")
}

clean_num <- function(x) {
  x |>
    str_squish() |>
    as.numeric()
}

extract_cells <- function(x) {
  str_split(x, "&")[[1]][-1] |>
    str_remove_all("\\\\") |>
    str_trim()
}

########################################################
# PARSE COEFFICIENTS
########################################################

coef_df <- tibble(row = coef_rows) |>
  mutate(
    row = clean_row(row),
    bin = str_extract(row, "dum\\\\_[0-9_]+") |>
      str_replace_all("\\\\_", "_"),
    vals = map(row, extract_cells)
  ) |>
  unnest_wider(vals, names_sep = "_") |>
  mutate(across(starts_with("vals"), clean_num))

########################################################
# PARSE STANDARD ERRORS
########################################################

se_df <- tibble(row = se_rows) |>
  mutate(
    vals = map(
      row,
      ~ str_extract_all(.x, "\\(([0-9\\.]+)\\)")[[1]] |>
        str_remove_all("[()]") |>
        as.numeric()
    )
  ) |>
  unnest_wider(vals, names_sep = "_")

########################################################
# MODEL TITLES (AUTHORITATIVE ORDER)
########################################################

model_titles <- c(
  "Low Income_Cold",
  "Low Income_Temperate",
  "Low Income_Hot",
  "Middle Income_Cold",
  "Middle Income_Temperate",
  "Middle Income_Hot",
  "High Income_Cold",
  "High Income_Temperate",
  "High Income_Hot"
) |>
  str_replace("_", " - ")

########################################################
# LONG FORMAT (9 MODELS, ORDER PRESERVED)
########################################################

coef_long <- coef_df |>
  pivot_longer(
    cols = starts_with("vals"),
    names_to = "model_id",
    values_to = "estimate"
  ) |>
  mutate(
    model_index = as.integer(str_remove(model_id, "vals_")),
    model = model_titles[model_index]
  ) |>
  select(bin, model, model_index, estimate)

se_long <- coef_df |>
  select(bin) |>
  bind_cols(se_df) |>
  pivot_longer(
    cols = starts_with("vals"),
    names_to = "model_id",
    values_to = "se"
  ) |>
  mutate(
    model_index = as.integer(str_remove(model_id, "vals_")),
    model = model_titles[model_index]
  ) |>
  select(bin, model, model_index, se)

reg_long <- coef_long |>
  left_join(se_long, by = c("bin", "model", "model_index")) |>
  mutate(
    lower = estimate - 1.96 * se,
    upper = estimate + 1.96 * se
  )

########################################################
# BIN LABELS + ORDER (AUTHORITATIVE)
########################################################

NEW_LABELS <- c(
  dum_9  = "< 9",
  dum_10 = "10–11",
  dum_12 = "12–13",
  dum_14 = "14–15",
  dum_16 = "16–17",
  dum_18 = "18–19",
  dum_20 = "20–21",
  dum_22 = "22–23",
  dum_24 = "24–25",
  dum_26 = "26–27",
  dum_28 = "28–29",
  dum_30 = "30–31",
  dum_32 = "32–33",
  dum_34 = "34–35",
  dum_36 = "36–37",
  dum_38 = "> 38"
)

bin_order <- names(NEW_LABELS)

########################################################
# COMPLETE DATA + LOCK FACET ORDER (OPTIONAL FIX)
########################################################

reg_long <- reg_long |>
  complete(
    model,
    bin = bin_order,
    fill = list(
      estimate = 0,
      se       = 0,
      lower    = 0,
      upper    = 0
    )
  ) |>
  mutate(
    bin_index = match(bin, bin_order),
    bin_label = factor(
      recode(bin, !!!NEW_LABELS),
      levels = NEW_LABELS
    ),
    model = factor(model, levels = model_titles)
  )

########################################################
# LINE PLOT WITH CI RIBBON
########################################################

p <- ggplot(
  reg_long,
  aes(
    x = bin_index,
    y = estimate
  )
) +
  geom_ribbon(
    aes(ymin = lower, ymax = upper),
    fill = "grey70",
    alpha = 0.4
  ) +
  geom_line(
    color = "red",
    linewidth = 1
  ) +
  geom_point(
    color = "red",
    size = 2
  ) +
  geom_hline(
    yintercept = 0,
    color = "black",
    linewidth = 0.6
  ) +
  facet_wrap(~ model, ncol = 3) +
  scale_x_continuous(
    breaks = seq_along(bin_order),
    labels = NEW_LABELS
  ) +
  coord_cartesian(ylim = c(-1, 1)) +
  labs(
    x = "Bin",
    y = "Estimate",
    title = "Regression Coefficients - Max Temperature"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

########################################################
# SAVE OUTPUT
########################################################

ggsave(
  "all_models_line_ci2.png",
  p,
  width = 16,
  height = 10,
  dpi = 300
)



########################################################
# LOAD PACKAGES
########################################################

library(tidyverse)

########################################################
# INPUT DATA (COUNTS BY TEMPERATURE BIN)
########################################################

counts_df <- tibble(
  bin = c(
    "dum_9", "dum_38", "dum_10_11", "dum_12_13", "dum_14_15",
    "dum_16_17", "dum_18_19", "dum_20_21", "dum_22_23",
    "dum_24_25", "dum_26_27", "dum_28_29", "dum_30_31",
    "dum_32_33", "dum_34_35", "dum_36_37"
  ),
  count = c(
    38843, 220, 45123, 72948, 91753, 92107, 89047, 84213,
    78840, 68055, 62779, 60231, 51256, 30003, 10192, 1441
  )
)

########################################################
# BIN LABELS + ORDER (AUTHORITATIVE)
########################################################

NEW_LABELS <- c(
  dum_9       = "< 9",
  dum_10_11   = "10–11",
  dum_12_13   = "12–13",
  dum_14_15   = "14–15",
  dum_16_17   = "16–17",
  dum_18_19   = "18–19",
  dum_20_21   = "20–21",
  dum_22_23   = "22–23",
  dum_24_25   = "24–25",
  dum_26_27   = "26–27",
  dum_28_29   = "28–29",
  dum_30_31   = "30–31",
  dum_32_33   = "32–33",
  dum_34_35   = "34–35",
  dum_36_37   = "36–37",
  dum_38      = "> 38"
)

bin_order <- names(NEW_LABELS)

########################################################
# ADD BIN INDEX + FACTOR LABELS (KEY STEP)
########################################################

counts_df <- counts_df |>
  mutate(
    bin_index = match(bin, bin_order),
    bin_label = factor(
      recode(bin, !!!NEW_LABELS),
      levels = NEW_LABELS
    )
  )

########################################################
# COLOR PALETTE (ORIGINAL)
########################################################

my_cols <- function(n) {
  grDevices::colorRampPalette(
    c("#4575b4", "#ffffbf", "#d73027")
  )(n)
}

n_bins <- length(bin_order)

########################################################
# BAR GRAPH (ORDER + GRADIENT PRESERVED)
########################################################

p_counts <- ggplot(
  counts_df,
  aes(
    x = bin_label,
    y = count,
    fill = bin_index
  )
) +
  geom_col(width = 0.8) +
  scale_fill_gradientn(
    colors = my_cols(n_bins),
    limits = c(1, n_bins),
    guide = "none"
  ) +
  labs(
    x = "Maximum temperature bin",
    y = "Number of observations",
    title = "Distribution of observations by temperature bin"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

########################################################
# DISPLAY PLOT
########################################################

ggsave( "histo_models.png", p_counts, width = 14, height = 10, dpi = 300 )

